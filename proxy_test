import requests, pathlib, re

PROXY_FILE = "proxies.txt"
NITTER_URL = "https://nitter.tiekoetter.com/ChipotleTweets"
CF_RE = re.compile(r"(verify you are human|just a moment|cdn-cgi/challenge)", re.I)

def load_proxies():
    path = pathlib.Path(PROXY_FILE)
    if not path.exists():
        return []
    return [line.strip() for line in path.read_text().splitlines() if line.strip()]

def blocked_by_cloudflare(html: str) -> bool:
    return bool(CF_RE.search(html))

def test_proxy(proxy):
    proxy_dict = {
        "https": proxy
    }
    try:
        response = requests.get(NITTER_URL, proxies=proxy_dict, timeout=10)
        if response.status_code == 200 and not blocked_by_cloudflare(response.text):
            print(f"Proxy works: {proxy}")
            return True
        else:
            print(f"Proxy blocked by Cloudflare or invalid page: {proxy}")
    except Exception as e:
        print(f"Failed: {proxy} ({e})")
    return False

if __name__ == "__main__":
    proxies = load_proxies()
    working = []

    for p in proxies:
        if test_proxy(p):
            working.append(p)

    print(f"{len(working)} proxies worked")
